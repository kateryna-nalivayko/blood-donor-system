{% extends "base.html" %}

{% block title %}Пошук донорів - Blood Donor System{% endblock %}

{% block content %}
<div class="columns">
  <!-- Sidebar (simplified) -->
  <div class="column is-one-quarter">
    <div class="box">
      <aside class="menu">
        <p class="menu-label">Панель керування</p>
        <ul class="menu-list">
          <li>
            <a href="/pages/hospital_staff/dashboard">
              <span class="icon"><i class="fas fa-home"></i></span>
              <span>Головна</span>
            </a>
          </li>
          <li>
            <a href="/pages/hospital_staff/blood-requests">
              <span class="icon"><i class="fas fa-tint"></i></span>
              <span>Запити на кров</span>
            </a>
          </li>
        </ul>

        <p class="menu-label">Звіти</p>
        <ul class="menu-list">
          <li>
            <a href="/pages/hospital_staff/reports">
              <span class="icon"><i class="fas fa-chart-bar"></i></span>
              <span>Статистика запитів</span>
            </a>
          </li>
          <li>
            <a href="/pages/hospital_staff/custom-queries" class="is-active">
              <span class="icon"><i class="fas fa-database"></i></span>
              <span>Користувацькі запити</span>
            </a>
          </li>
        </ul>
      </aside>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="column">
    <div class="box">
      <h1 class="title has-text-danger">
        <span class="icon"><i class="fas fa-database"></i></span>
        <span>Пошук донорів</span>
      </h1>
      <p class="subtitle">Використовуйте спеціальні запити для пошуку донорів</p>

      <!-- Query tabs -->
      <div class="tabs is-boxed">
        <ul id="query-tabs">
          <li class="is-active" data-target="query-donations-section">
            <a>
              <span class="icon"><i class="fas fa-history"></i></span>
              <span>За кількістю донацій</span>
            </a>
          </li>
          <li data-target="query-eligible-section">
            <a>
              <span class="icon"><i class="fas fa-check-circle"></i></span>
              <span>Доступні донори</span>
            </a>
          </li>
        </ul>
      </div>

      <!-- Query 1: Donors by Blood Type and Min Donations -->
      <div id="query-donations-section" class="query-section">
        <div class="notification is-light">
          <p>Цей запит дозволяє знайти донорів з обраною групою крові, які зробили принаймні визначену кількість донацій.</p>
        </div>

        <!-- Query Form -->
        <div class="box">
          <h3 class="subtitle has-text-danger">
            <span class="icon"><i class="fas fa-tint"></i></span>
            <span>Параметри пошуку</span>
          </h3>
          
          <form id="donor-search-form">
            <div class="field">
              <label class="label">Група крові</label>
              <div class="control">
                <div class="select">
                  <select name="blood_type" required>
                    <option value="">Виберіть групу крові</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Мінімальна кількість донацій</label>
              <div class="control">
                <input class="input" type="number" name="min_donations" min="1" value="1" required>
              </div>
            </div>
            <div class="field">
              <label class="label">Максимальна кількість результатів</label>
              <div class="control">
                <input class="input" type="number" name="limit" min="1" max="1000" value="100" required>
              </div>
            </div>
            <div class="field">
              <div class="control">
                <button type="submit" class="button is-danger">
                  <span class="icon"><i class="fas fa-search"></i></span>
                  <span>Виконати запит</span>
                </button>
              </div>
            </div>
          </form>
        </div>
        
        <!-- Results Section -->
        <div id="query-results-donations" class="query-results mt-5" style="display: none;">
          <h3 class="subtitle">Результати пошуку</h3>
          <div class="results-content"></div>
        </div>
      </div>

      <!-- Query 2: Eligible Donors by Blood Type -->
      <div id="query-eligible-section" class="query-section" style="display: none;">
        <div class="notification is-light">
          <p>Цей запит дозволяє знайти доступних донорів з обраною групою крові, які не здавали кров протягом зазначеної кількості днів.</p>
        </div>

        <!-- Query Form -->
        <div class="box">
          <h3 class="subtitle has-text-danger">
            <span class="icon"><i class="fas fa-user-check"></i></span>
            <span>Параметри пошуку</span>
          </h3>
          
          <form id="eligible-donor-search-form">
            <div class="field">
              <label class="label">Група крові</label>
              <div class="control">
                <div class="select">
                  <select name="blood_type" required>
                    <option value="">Виберіть групу крові</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Мінімальна кількість днів від останньої донації</label>
              <div class="control">
                <input class="input" type="number" name="days_since_donation" min="0" value="56" required>
                <p class="help">Стандартний період між донаціями - 56 днів</p>
              </div>
            </div>
            <div class="field">
              <label class="label">Максимальна кількість результатів</label>
              <div class="control">
                <input class="input" type="number" name="limit" min="1" max="1000" value="100" required>
              </div>
            </div>
            <div class="field">
              <div class="control">
                <button type="submit" class="button is-danger">
                  <span class="icon"><i class="fas fa-search"></i></span>
                  <span>Виконати запит</span>
                </button>
              </div>
            </div>
          </form>
        </div>
        
        <!-- Results Section -->
        <div id="query-results-eligible" class="query-results mt-5" style="display: none;">
          <h3 class="subtitle">Результати пошуку</h3>
          <div class="results-content"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Tab switching functionality
  const queryTabs = document.getElementById('query-tabs').querySelectorAll('li');
  const querySections = document.querySelectorAll('.query-section');
  
  queryTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // Deactivate all tabs
      queryTabs.forEach(t => t.classList.remove('is-active'));
      // Hide all sections
      querySections.forEach(s => s.style.display = 'none');
      
      // Activate clicked tab
      this.classList.add('is-active');
      
      // Show corresponding section
      const targetId = this.getAttribute('data-target');
      document.getElementById(targetId).style.display = 'block';
    });
  });
  
  // First query form submission
  const searchForm = document.getElementById('donor-search-form');
  const resultsContainerDonations = document.getElementById('query-results-donations');
  const resultsContentDonations = resultsContainerDonations.querySelector('.results-content');
  
  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
      params.append(key, value);
    }
    
    const url = `/donors/query/by-blood-type-min-donations?${params.toString()}`;
    
    // Show loading indicator
    resultsContentDonations.innerHTML = `
      <div class="has-text-centered">
        <span class="icon is-large">
          <i class="fas fa-spinner fa-pulse fa-2x"></i>
        </span>
        <p>Завантаження результатів...</p>
      </div>
    `;
    resultsContainerDonations.style.display = 'block';
    
    fetch(url, {
      headers: {
        'Accept': 'application/json'
      },
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        if (response.status === 401) {
          throw new Error('Необхідна авторизація. Будь ласка, увійдіть в систему.');
        }
        throw new Error(`Помилка запиту: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      resultsContainerDonations.style.display = 'block';
      displayDonationResults(data, resultsContentDonations);
    })
    .catch(error => {
      resultsContentDonations.innerHTML = `
        <div class="notification is-danger">
          <button class="delete" onclick="this.parentNode.style.display='none'"></button>
          ${error.message}
        </div>
      `;
    });
  });
  
  // Second query form submission (eligible donors)
  const eligibleSearchForm = document.getElementById('eligible-donor-search-form');
  const resultsContainerEligible = document.getElementById('query-results-eligible');
  const resultsContentEligible = resultsContainerEligible.querySelector('.results-content');
  
  eligibleSearchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const params = new URLSearchParams();
    
    for (const [key, value] of formData.entries()) {
      params.append(key, value);
    }
    
    const url = `/donors/query/eligible-donors-by-blood-type?${params.toString()}`;
    
    // Show loading indicator
    resultsContentEligible.innerHTML = `
      <div class="has-text-centered">
        <span class="icon is-large">
          <i class="fas fa-spinner fa-pulse fa-2x"></i>
        </span>
        <p>Завантаження результатів...</p>
      </div>
    `;
    resultsContainerEligible.style.display = 'block';
    
    fetch(url, {
      headers: {
        'Accept': 'application/json'
      },
      credentials: 'same-origin'
    })
    .then(response => {
      if (!response.ok) {
        if (response.status === 401) {
          throw new Error('Необхідна авторизація. Будь ласка, увійдіть в систему.');
        }
        throw new Error(`Помилка запиту: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      resultsContainerEligible.style.display = 'block';
      displayEligibleResults(data, resultsContentEligible);
    })
    .catch(error => {
      resultsContentEligible.innerHTML = `
        <div class="notification is-danger">
          <button class="delete" onclick="this.parentNode.style.display='none'"></button>
          ${error.message}
        </div>
      `;
    });
  });
  
  // Display formatted results for first query
  function displayDonationResults(data, container) {
    if (data.length === 0) {
      container.innerHTML = `
        <div class="notification is-info">
          <button class="delete" onclick="this.parentNode.style.display='none'"></button>
          Немає результатів для заданих параметрів.
        </div>
      `;
      return;
    }
    
    let html = `
      <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ім'я</th>
              <th>Email</th>
              <th>Телефон</th>
              <th>Група крові</th>
              <th>К-сть донацій</th>
              <th>Об'єм (мл)</th>
              <th>Остання донація</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    data.forEach(donor => {
      html += `
        <tr>
          <td>${donor.donor_id}</td>
          <td>${donor.first_name} ${donor.last_name}</td>
          <td>${donor.email || '-'}</td>
          <td>${donor.phone_number || '-'}</td>
          <td><span class="tag is-danger">${donor.blood_type}</span></td>
          <td>${donor.donation_count}</td>
          <td>${donor.total_donated_ml || 0} мл</td>
          <td>${donor.last_donation_date ? new Date(donor.last_donation_date).toLocaleDateString('uk-UA') : '-'}</td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
      <div class="notification is-light mt-4">
        <p>Знайдено донорів: <strong>${data.length}</strong></p>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Display formatted results for second query (eligible donors)
  function displayEligibleResults(data, container) {
    if (data.length === 0) {
      container.innerHTML = `
        <div class="notification is-info">
          <button class="delete" onclick="this.parentNode.style.display='none'"></button>
          Немає результатів для заданих параметрів.
        </div>
      `;
      return;
    }
    
    let html = `
      <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ім'я</th>
              <th>Email</th>
              <th>Телефон</th>
              <th>Група крові</th>
              <th>Останнє донорство</th>
              <th>Днів від останньої</th>
              <th>Вік</th>
              <th>Статус</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    data.forEach(donor => {
      html += `
        <tr>
          <td>${donor.donor_id}</td>
          <td>${donor.first_name} ${donor.last_name}</td>
          <td>${donor.email || '-'}</td>
          <td>${donor.phone_number || '-'}</td>
          <td><span class="tag is-danger">${donor.blood_type}</span></td>
          <td>${donor.last_donation_date ? new Date(donor.last_donation_date).toLocaleDateString('uk-UA') : 'Немає'}</td>
          <td>${donor.days_since_donation !== null ? donor.days_since_donation : '-'}</td>
          <td>${donor.age || '-'}</td>
          <td>
            <span class="tag ${donor.can_donate ? 'is-success' : 'is-warning'}">
              ${donor.can_donate ? 'Доступний' : 'Недоступний'}
            </span>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
      <div class="notification is-light mt-4">
        <p>Знайдено донорів: <strong>${data.length}</strong></p>
      </div>
    `;
    
    container.innerHTML = html;
  }
});
</script>
{% endblock %}